<!DOCTYPE html>
<html>
<head>
	<title>Dania</title>
<script src="node_modules/handjs/hand.min.js" type="text/javascript" charset="utf-8" async></script>

<script src="node_modules/babylonjs/Oimo.js" type="text/javascript" charset="utf-8" async></script>
<script src="node_modules/babylonjs/babylon.max.js" type="text/javascript"></script>

<script type="text/javascript" src="js/utilities.js"></script>

<script type="text/javascript" src="js/boxmesh.js"></script>

<script type="text/javascript" src="js/chunk.js"></script>
<script type="text/javascript" src="js/chunkDisplayer.js"></script>
<script type="text/javascript" src="js/terrainGenerator.js"></script>
<script type="text/javascript" src="js/worldManager.js"></script>

<link rel="stylesheet" href="assets/stylesheets/index.css">
</head>
<body>

    <canvas id='renderCanvas'>
    	
    </canvas>
    <div id="debugPanel">
        <div id="chunkInfo">
            <p id="info">currentChunk:</p>
            <span id="chunkX"></span>
            <span id="chunkY"></span>
        </div>
        <div id="coordInfo">
            <p>currentPosInWorld:</p>
            <span id="posX"></span>
            <span id="posY"></span>
        </div>
    </div>
    <script>
        var DEBUG = true;
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        var startPoint = new BABYLON.Vector3(10 * 16, 4, 10 * 16);
        var camera;
        var worldWidthInChunks = 25;
        var worldDepthInChunks = 25;

        var createScene = function () {
            var scene = new BABYLON.Scene(engine);

            scene.collisionsEnabled = true;
            scene.gravity = new BABYLON.Vector3(0, -5, 0);

            camera = new BABYLON.FreeCamera("freeCamera", startPoint, scene);
            //camera = new BABYLON.ArcRotateCamera("arcCamera", 1, 0.8, 10, new BABYLON.Vector3(0, -1, 0), scene);
            camera.attachControl(canvas, false);
            camera.keysUp.push(87);
            camera.keysDown.push(83);
            camera.keysRight.push(68);
            camera.keysLeft.push(65);

            camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            camera.applyGravity = false;
            camera.checkCollisions = true;
            camera.speed = 0.6;

            var sphere = BABYLON.Mesh.CreateSphere("sphere1", 16, 2, scene);

            var sphereMaterial = new BABYLON.StandardMaterial("sphereBox", scene);
            sphere.material = sphereMaterial;
            sphere.position = new BABYLON.Vector3(165,4,165);
            sphere.checkCollisions = true;
            sphere.applyGravity = true;
            

            var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 25, 0), scene);
            light.intensity = 1.0;

            // Skybox
            var skybox = BABYLON.Mesh.CreateBox("skyBox", 6000.0, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/images/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;

            return scene;
        };

        var createWorldManager = function (scene) {
            var worldManager = new WorldManager(worldWidthInChunks, worldDepthInChunks, 1, scene);
            return worldManager;
        };

        var scene = createScene();


        var worldManager = createWorldManager(scene);

        var del = false;
        var add = false;    

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function getChar(event) {
            if (event.which == null) {
                return String.fromCharCode(event.keyCode) // IE
            } else if (event.which!=0 && event.charCode!=0) {
                return String.fromCharCode(event.which)   // the rest
            } else {
                return null // special key
            }
        }

        canvas.addEventListener('mouseup', function (evt) {
            var mousePos = getMousePos(canvas, evt);
            //worldManager.removeFromCoords(mousePos.x, mousePos.y, camera);
            worldManager.addFromCoords(mousePos.x, mousePos.y, camera);
        }, false);

        engine.runRenderLoop(function () {
            scene.render();
        });

        setInterval(function () {
            worldManager.setPlayerPosition(camera.position.x, camera.position.y, camera.position.z);
        }, 500);

        window.addEventListener("resize", function () {
            engine.resize();
        });

        if(DEBUG){
            setInterval(function(){
                posx = document.getElementById('posX');
                posy = document.getElementById('posY');
                posx.innerHTML = Math.round(camera.position.x);
                posy.innerHTML = Math.round(camera.position.z);
                worldManager.displayCurrentPlayerChunk()
            }, 500);
            scene.debugLayer.show();
        }
    </script>
</body>
</html>


